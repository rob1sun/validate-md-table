<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>BV / Metadata – Matchning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --border: #d0d0d7;
      --text: #222;
      --muted: #666;
      --accent: #0052cc;
      --ok: #1e8e3e;
      --ok-soft: #e1f3e5;
      --warn: #c5221f;
      --warn-soft: #fde8e6;
      --btn-radius: 999px;
      --badge-radius: 999px;
      --transition: 150ms ease-in-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #eef2ff 0, #f5f5f7 45%, #f5f5f7 100%);
      color: var(--text);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1rem 2rem;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 1rem;
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
      padding: 0.75rem 0.75rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: space-between;
    }

    .filters-left,
    .filters-right {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    select {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      outline: none;
      min-width: 120px;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0, 82, 204, 0.15);
    }

    .decision-filter-group {
      display: inline-flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.78rem;
    }

    .decision-filter-group .filter-label {
      font-size: 0.8rem;
      color: var(--muted);
      margin-right: 0.25rem;
    }

    .chk {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-right: 0.2rem;
      cursor: pointer;
    }

    .chk input[type="checkbox"] {
      accent-color: var(--accent);
    }

    .table-container {
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.06);
      overflow: auto;
      max-height: min(70vh, 800px);
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 950px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: linear-gradient(to bottom, #f7f7fb, #f0f1f7);
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
    }

    th,
    td {
      padding: 0.4rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid #ececf2;
      vertical-align: middle;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 0.75rem;
      color: #555;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    tr:hover td {
      background: #f9fafb;
    }

    td[data-col="bvName"],
    td[data-col="entityOrgName"],
    td[data-col="entityOrgDispName"] {
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 260px;
      overflow: hidden;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.1rem 0.55rem;
      border-radius: var(--badge-radius);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-ok {
      background: var(--ok-soft);
      color: var(--ok);
      border: 1px solid rgba(28, 148, 74, 0.15);
    }

    .badge-kolla {
      background: var(--warn-soft);
      color: var(--warn);
      border: 1px solid rgba(197, 34, 31, 0.15);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--btn-radius);
      border: 1px solid transparent;
      font-size: 0.75rem;
      padding: 0.18rem 0.7rem;
      cursor: pointer;
      background: #f3f4f6;
      color: #111827;
      transition:
        background var(--transition),
        transform var(--transition),
        box-shadow var(--transition),
        border-color var(--transition),
        color var(--transition);
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-ghost {
      background: transparent;
      border-color: var(--border);
      color: var(--muted);
    }

    .btn-primary {
      background: var(--ok);
      color: white;
      box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
      border-color: rgba(16, 185, 129, 0.6);
    }

    .btn-danger {
      background: var(--warn);
      color: white;
      border-color: rgba(197, 34, 31, 0.6);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-0.5px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.12);
      background: #e5e7eb;
    }

    .btn-primary:hover:not(:disabled) {
      background: #0f7a34;
    }

    .btn-danger:hover:not(:disabled) {
      background: #a6100f;
    }

    .btn-sm {
      font-size: 0.7rem;
      padding: 0.12rem 0.6rem;
    }

    .cell-actions {
      display: inline-flex;
      gap: 0.3rem;
      align-items: center;
    }

    .pill {
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 0.18rem 0.7rem;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .status-indicator {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .status-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      margin-right: 0.25rem;
    }

    .status-dot.loading {
      background: #f97316;
    }

    .status-dot.error {
      background: #ef4444;
    }

    .row-count {
      font-size: 0.75rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .empty-state {
      padding: 0.8rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    /* Modal */

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal.show {
      display: flex;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
    }

    .modal-dialog {
      position: relative;
      background: #fff;
      border-radius: 0.9rem;
      padding: 1rem 1.2rem 1rem;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.3);
      z-index: 1;
      max-height: 80vh;
      overflow: auto;
    }

    .modal-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
    }

    .modal-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .modal-status-badge {
      font-size: 0.7rem;
    }

    .modal-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .modal-badge-auto {
      background: var(--ok-soft);
      color: var(--ok);
      border: 1px solid rgba(28, 148, 74, 0.2);
    }

    .modal-badge-manual-ok {
      background: #e0ecff;
      color: #1d4ed8;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .modal-badge-manual-nekad {
      background: var(--warn-soft);
      color: var(--warn);
      border: 1px solid rgba(220, 38, 38, 0.3);
    }

    .modal-badge-kolla {
      background: var(--warn-soft);
      color: var(--warn);
      border: 1px solid rgba(220, 38, 38, 0.3);
    }

    .modal-close {
      position: absolute;
      top: 0.4rem;
      right: 0.5rem;
      border: none;
      background: transparent;
      font-size: 1.1rem;
      cursor: pointer;
      color: #9ca3af;
    }

    .modal-close:hover {
      color: #4b5563;
    }

    .modal-body {
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.25rem;
    }

    .modal-row {
      display: grid;
      grid-template-columns: 130px 1fr;
      gap: 0.4rem;
      padding: 0.15rem 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .modal-row-label {
      font-weight: 600;
      color: #4b5563;
    }

    .modal-row-value {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-word;
    }

    @media (max-width: 768px) {
      .page {
        padding-inline: 0.75rem;
      }
      h1 {
        font-size: 1.2rem;
      }
      .modal-dialog {
        max-width: 95vw;
      }
      .modal-row {
        grid-template-columns: 110px 1fr;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <h1>BV / Entity – Matchning</h1>
    <div class="subtitle">
      Jämför Bolagsverkets namn med metadata och flagga avvikelser.
    </div>
  </header>

  <section class="card">
    <div class="filters">
      <div class="filters-left">
        <div>
          <label for="matchFilter">Match-filter</label><br />
          <select id="matchFilter">
            <option value="ALL">Alla</option>
            <option value="OK">Endast OK</option>
            <option value="KOLLA">Endast KOLLA</option>
          </select>
        </div>

        <div class="decision-filter-group">
          <span class="filter-label">Godkänn-filter</span>
          <label class="chk">
            <input type="checkbox" name="decisionFilter" value="NONE" checked />
            Tom
          </label>
          <label class="chk">
            <input type="checkbox" name="decisionFilter" value="Match" checked />
            Match
          </label>
          <label class="chk">
            <input type="checkbox" name="decisionFilter" value="Godkänd" checked />
            Godkänd
          </label>
          <label class="chk">
            <input type="checkbox" name="decisionFilter" value="Nekad" checked />
            Nekad
          </label>
        </div>
      </div>

      <div class="filters-right">
        <span id="rowCount" class="row-count"></span>
        <button id="syncButton" class="btn btn-sm btn-ghost">
          Läs in metadata
        </button>
        <button id="exportCsvButton" class="btn btn-sm">
          Exportera CSV
        </button>
        <button id="exportJsonButton" class="btn btn-sm btn-ghost">
          Exportera JSON
        </button>
        <span id="statusIndicator" class="status-indicator">
          <span class="status-dot loading"></span> Läser in...
        </span>
      </div>
    </div>

    <div class="table-container" id="tableContainer">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>Orgnr</th>
          <th>BV: Namn</th>
          <th>Entity: OrgName</th>
          <th>Entity: OrgDispName</th>
          <th>Match</th>
          <th>Godkänn</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        <tr>
          <td colspan="7" class="empty-state">
            Hämtar data från servern...
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- Modal -->
<div id="detailModal" class="modal">
  <div id="modalBackdrop" class="modal-backdrop"></div>
  <div class="modal-dialog">
    <button id="modalClose" class="modal-close" type="button">&times;</button>
    <div class="modal-header-row">
      <div class="modal-title">Detaljer</div>
      <div id="modalStatusBadge" class="modal-status-badge"></div>
    </div>
    <div id="modalContent" class="modal-body"></div>
  </div>
</div>

<script>
  (function () {
    const API_BASE = "/api";

    let allRows = [];
    let filteredRows = [];
    let isLoading = false;

    const matchFilterEl = document.getElementById("matchFilter");
    const decisionFilterBoxes = Array.from(
      document.querySelectorAll('input[name="decisionFilter"]')
    );
    const tableBody = document.getElementById("tableBody");
    const statusIndicator = document.getElementById("statusIndicator");
    const syncButton = document.getElementById("syncButton");
    const exportCsvButton = document.getElementById("exportCsvButton");
    const exportJsonButton = document.getElementById("exportJsonButton");
    const rowCountEl = document.getElementById("rowCount");

    const detailModal = document.getElementById("detailModal");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalCloseBtn = document.getElementById("modalClose");
    const modalContent = document.getElementById("modalContent");

    function setStatus(text, mode) {
      statusIndicator.innerHTML = "";
      const dot = document.createElement("span");
      dot.className = "status-dot";
      if (mode === "loading") dot.classList.add("loading");
      if (mode === "error") dot.classList.add("error");
      statusIndicator.appendChild(dot);
      const span = document.createElement("span");
      span.textContent = " " + text;
      statusIndicator.appendChild(span);
    }

    function updateRowCount() {
      if (!rowCountEl) return;
      rowCountEl.textContent = filteredRows.length + " poster";
    }

    async function fetchTable() {
      isLoading = true;
      setStatus("Läser in...", "loading");
      try {
        const res = await fetch(API_BASE + "/table", {
          method: "GET",
          headers: {
            accept: "application/json",
          },
        });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        // Ta bara riktiga organisationer, filtrera bort __meta__-keys
        allRows = (Array.isArray(data.rows) ? data.rows : [])
          .filter(
            (row) =>
              row &&
              row.orgnr &&
              !String(row.orgnr).startsWith("__meta__")
          )
          .sort((a, b) =>
            String(a.orgnr || "").localeCompare(String(b.orgnr || ""))
          );

        // Tilldela stabilt löpnummer (ID) baserat på sorterad ordning
        allRows.forEach((row, idx) => {
          row._id = idx + 1;
        });

        filteredRows = allRows.slice();
        applyFilters();
        setStatus(`Klar – ${allRows.length} rader totalt`, "ok");
      } catch (err) {
        console.error(err);
        tableBody.innerHTML =
          '<tr><td colspan="7" class="empty-state">Kunde inte läsa data från servern. Försök igen eller kontrollera loggarna.</td></tr>';
        filteredRows = [];
        updateRowCount();
        setStatus("Fel vid hämtning", "error");
      } finally {
        isLoading = false;
      }
    }

    function applyFilters() {
      const matchF = matchFilterEl.value;

      const selectedDecisions = decisionFilterBoxes
        .filter((cb) => cb.checked)
        .map((cb) => cb.value);

      filteredRows = allRows.filter((row) => {
        // Match-filter
        if (matchF !== "ALL" && row.match !== matchF) {
          return false;
        }

        // Godkänn-filter: NONE / Match / Godkänd / Nekad
        const dec = row.decision || null;
        let bucket;

        if (dec === "Godkänd" || dec === "Nekad") {
          bucket = dec;
        } else if (row.match === "OK") {
          bucket = "Match";
        } else {
          bucket = "NONE";
        }

        if (selectedDecisions.length === 0) {
          return false;
        }

        return selectedDecisions.includes(bucket);
      });

      renderTable();
      updateRowCount();
    }

    function renderTable() {
      if (!filteredRows.length) {
        tableBody.innerHTML =
          '<tr><td colspan="7" class="empty-state">Inga rader matchar nuvarande filter.</td></tr>';
        return;
      }

      tableBody.innerHTML = "";

      for (const row of filteredRows) {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = row._id ?? "";
        tr.appendChild(tdId);

        const tdOrgnr = document.createElement("td");
        tdOrgnr.textContent = row.orgnr ?? "";
        tr.appendChild(tdOrgnr);

        const tdBvName = document.createElement("td");
        tdBvName.textContent = row.bvName ?? "";
        tdBvName.setAttribute("data-col", "bvName");
        tr.appendChild(tdBvName);

        const tdOrgName = document.createElement("td");
        tdOrgName.textContent = row.entityOrgName ?? "";
        tdOrgName.setAttribute("data-col", "entityOrgName");
        tr.appendChild(tdOrgName);

        const tdOrgDispName = document.createElement("td");
        tdOrgDispName.textContent = row.entityOrgDispName ?? "";
        tdOrgDispName.setAttribute("data-col", "entityOrgDispName");
        tr.appendChild(tdOrgDispName);

        const tdMatch = document.createElement("td");
        const badge = document.createElement("span");
        badge.className =
          "badge " + (row.match === "OK" ? "badge-ok" : "badge-kolla");
        badge.textContent = row.match === "OK" ? "OK" : "KOLLA";
        tdMatch.appendChild(badge);
        tr.appendChild(tdMatch);

        const tdActions = document.createElement("td");
        tdActions.appendChild(buildActionCell(row));
        tr.appendChild(tdActions);

        // Klick på rad öppnar modal (men inte om man klickar på knappar)
        tr.addEventListener("click", (e) => {
          if (e.target.closest("button")) return;
          openModal(row);
        });

        tableBody.appendChild(tr);
      }
    }

    function buildActionCell(row) {
      const container = document.createElement("div");
      container.className = "cell-actions";

      // 1) Beslut finns: visa pill + Ändra (RESET mot backend)
      if (row.decision === "Godkänd" || row.decision === "Nekad") {
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = row.decision; // "Godkänd" eller "Nekad"
        container.appendChild(pill);

        const changeBtn = document.createElement("button");
        changeBtn.type = "button";
        changeBtn.className = "btn btn-sm btn-ghost";
        changeBtn.textContent = "Ändra";
        changeBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          resetDecision(row);
        });

        container.appendChild(changeBtn);
        return container;
      }

      // 2) Auto-match (match = OK, inget beslut): visa Match + Ändra
      if (row.match === "OK") {
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = "Match";
        container.appendChild(pill);

        const changeBtn = document.createElement("button");
        changeBtn.type = "button";
        changeBtn.className = "btn btn-sm btn-ghost";
        changeBtn.textContent = "Ändra";
        changeBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          renderManualDecisionButtons(container, row);
        });

        container.appendChild(changeBtn);
        return container;
      }

      // 3) Ingen match/decision: manuellt GODKÄNN/NEKA-läge direkt
      renderManualDecisionButtons(container, row);
      return container;
    }

    function renderManualDecisionButtons(container, row) {
      container.innerHTML = "";

      const approveBtn = document.createElement("button");
      approveBtn.type = "button";
      approveBtn.className = "btn btn-sm btn-primary";
      approveBtn.textContent = "GODKÄNN";

      const rejectBtn = document.createElement("button");
      rejectBtn.type = "button";
      rejectBtn.className = "btn btn-sm btn-danger";
      rejectBtn.textContent = "NEKA";

      approveBtn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        enterSaveState(container, row, "Godkänd");
      });
      rejectBtn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        enterSaveState(container, row, "Nekad");
      });

      container.appendChild(approveBtn);
      container.appendChild(rejectBtn);
    }

    function enterSaveState(container, row, pendingDecision) {
      container.innerHTML = "";

      const saveBtn = document.createElement("button");
      saveBtn.type = "button";
      saveBtn.className = "btn btn-sm btn-primary";
      saveBtn.textContent = "SPARA";

      const cancelBtn = document.createElement("button");
      cancelBtn.type = "button";
      cancelBtn.className = "btn btn-sm btn-ghost";
      cancelBtn.textContent = "ÅNGRA";

      saveBtn.addEventListener("click", async (ev) => {
        ev.stopPropagation();
        saveBtn.disabled = true;
        cancelBtn.disabled = true;
        await saveDecision(row, pendingDecision);
      });

      cancelBtn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        container.replaceWith(buildActionCell(row));
      });

      container.appendChild(saveBtn);
      container.appendChild(cancelBtn);
    }

    async function saveDecision(row, decision) {
      try {
        const res = await fetch(API_BASE + "/decision", {
          method: "POST",
          headers: {
            "content-type": "application/json",
            accept: "application/json",
          },
          body: JSON.stringify({ orgnr: row.orgnr, decision }),
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const updated = await res.json();

        const idx = allRows.findIndex((r) => r.orgnr === updated.orgnr);
        if (idx !== -1) {
          updated._id = allRows[idx]._id;
          allRows[idx] = updated;
        }

        Object.assign(row, updated);

        applyFilters();
        setStatus("Beslut sparat", "ok");
      } catch (err) {
        console.error(err);
        setStatus("Kunde inte spara beslut", "error");
        alert("Kunde inte spara beslutet. Kontrollera loggarna och försök igen.");
      }
    }

    async function resetDecision(row) {
      try {
        const res = await fetch(API_BASE + "/decision", {
          method: "POST",
          headers: {
            "content-type": "application/json",
            accept: "application/json",
          },
          body: JSON.stringify({ orgnr: row.orgnr, decision: "RESET" }),
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const updated = await res.json();

        const idx = allRows.findIndex((r) => r.orgnr === updated.orgnr);
        if (idx !== -1) {
          updated._id = allRows[idx]._id;
          allRows[idx] = updated;
        }

        Object.assign(row, updated);

        applyFilters();
        setStatus("Beslut återställt", "ok");
      } catch (err) {
        console.error(err);
        setStatus("Kunde inte återställa beslut", "error");
        alert("Kunde inte återställa beslutet. Kontrollera loggarna och försök igen.");
      }
    }

    function downloadFile(filename, mime, content) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportFilteredAsCsv() {
      if (!filteredRows.length) {
        alert("Det finns inga rader i den filtrerade listan att exportera.");
        return;
      }

      const headers = [
        "id",
        "orgnr",
        "entityId",
        "bvName",
        "entityOrgName",
        "entityOrgDispName",
        "match",
        "decision",
        "decidedAt",
      ];

      const sep = ";";

      const escape = (value) => {
        if (value === null || value === undefined) return "";
        const s = String(value).replace(/"/g, '""');
        return `"${s}"`;
      };

      const lines = [];
      lines.push(headers.map(escape).join(sep));

      for (const row of filteredRows) {
        const line = [
          row._id ?? "",
          row.orgnr ?? "",
          row.entityId ?? "",
          row.bvName ?? "",
          row.entityOrgName ?? "",
          row.entityOrgDispName ?? "",
          row.match ?? "",
          row.decision ?? "",
          row.decidedAt ?? "",
        ]
          .map(escape)
          .join(sep);
        lines.push(line);
      }

      const csvContent = "\uFEFF" + lines.join("\r\n");
      const ts = new Date().toISOString().replace(/[:T]/g, "-").slice(0, 16);
      const filename = `metadata-export-${ts}.csv`;

      downloadFile(filename, "text/csv;charset=utf-8;", csvContent);
    }

    function exportFilteredAsJson() {
      if (!filteredRows.length) {
        alert("Det finns inga rader i den filtrerade listan att exportera.");
        return;
      }

      const json = JSON.stringify(filteredRows, null, 2);
      const ts = new Date().toISOString().replace(/[:T]/g, "-").slice(0, 16);
      const filename = `metadata-export-${ts}.json`;

      downloadFile(filename, "application/json;charset=utf-8;", json);
    }

    function openModal(row) {
      if (!row) return;

      const badgeHost = document.getElementById("modalStatusBadge");
      if (badgeHost) {
        badgeHost.innerHTML = "";

        const badge = document.createElement("span");
        badge.classList.add("modal-badge");

        if (row.decision === "Godkänd") {
          badge.classList.add("modal-badge-manual-ok");
          badge.textContent = "Manuellt beslut: Godkänd";
        } else if (row.decision === "Nekad") {
          badge.classList.add("modal-badge-manual-nekad");
          badge.textContent = "Manuellt beslut: Nekad";
        } else if (row.match === "OK") {
          badge.classList.add("modal-badge-auto");
          badge.textContent = "Automatisk match (OK)";
        } else {
          badge.classList.add("modal-badge-kolla");
          badge.textContent = "Avvikelse – ingen automatisk match";
        }

        badgeHost.appendChild(badge);
      }

      const lines = [
        ["ID", row._id ?? ""],
        ["Orgnr", row.orgnr ?? ""],
        ["EntityID", row.entityId ?? ""],
        ["BV: Namn", row.bvName ?? ""],
        ["Entity: OrgName", row.entityOrgName ?? ""],
        ["Entity: OrgDispName", row.entityOrgDispName ?? ""],
        ["Match", row.match ?? ""],
        ["Decision", row.decision ?? ""],
        ["DecidedAt", row.decidedAt ?? ""],
      ];

      modalContent.innerHTML = "";
      for (const [label, value] of lines) {
        const rowEl = document.createElement("div");
        rowEl.className = "modal-row";

        const labelEl = document.createElement("div");
        labelEl.className = "modal-row-label";
        labelEl.textContent = label;

        const valueEl = document.createElement("div");
        valueEl.className = "modal-row-value";
        valueEl.textContent = value;

        rowEl.appendChild(labelEl);
        rowEl.appendChild(valueEl);
        modalContent.appendChild(rowEl);
      }

      detailModal.classList.add("show");
    }

    function closeModal() {
      detailModal.classList.remove("show");
    }

    syncButton.addEventListener("click", async () => {
      const ok = window.confirm(
        "VARNING: Är du säker på att du vill läsa in metadata?\n\n" +
          "Inläsningen kan ta upp till 20 minuter."
      );
      if (!ok) return;

      syncButton.disabled = true;

      try {
        let cursor = null;
        let totalProcessed = 0;
        let batch = 0;

        while (true) {
          batch++;
          const url =
            API_BASE +
            "/sync-metadata" +
            (cursor ? "?cursor=" + encodeURIComponent(cursor) : "");

          setStatus(
            `Läser in metadata... (batch ${batch}, totalt ${totalProcessed} uppdateringar)`,
            "loading"
          );

          const res = await fetch(url, {
            method: "POST",
            headers: { accept: "application/json" },
          });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }

          const data = await res.json();
          console.log("Sync result", data);

          totalProcessed += data.processed || 0;

          if (data.done || !data.cursor) {
            break;
          }

          cursor = data.cursor;
        }

        await fetchTable();
        setStatus(
          `Metadata inläst – ${totalProcessed} uppdateringar`,
          "ok"
        );
      } catch (err) {
        console.error(err);
        setStatus("Fel vid inläsning av metadata", "error");
        alert("Kunde inte läsa in metadata. Kontrollera loggarna och försök igen.");
      } finally {
        syncButton.disabled = false;
      }
    });

    matchFilterEl.addEventListener("change", applyFilters);
    decisionFilterBoxes.forEach((cb) =>
      cb.addEventListener("change", applyFilters)
    );
    exportCsvButton.addEventListener("click", exportFilteredAsCsv);
    exportJsonButton.addEventListener("click", exportFilteredAsJson);

    modalCloseBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    fetchTable();
  })();
</script>
</body>
</html>
